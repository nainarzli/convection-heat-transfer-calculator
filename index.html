<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forced Convection Heat Transfer Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f8ff;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        header {
            grid-column: 1 / -1;
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 2.4rem;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .flowchart-section, .calculator-section {
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        h2 {
            color: #1a2980;
            border-bottom: 3px solid #26d0ce;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .flowchart-section h2:before { content: "üìä"; }
        .calculator-section h2:before { content: "üßÆ"; }

        .flowchart-container {
            background: #f8fdff;
            border: 2px dashed #cce7ff;
            border-radius: 10px;
            padding: 20px;
            min-height: 500px;
            overflow: auto;
        }

        .flow-step {
            background: white;
            border: 2px solid;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        .flow-step.start { border-color: #4CAF50; background: #e8f5e9; }
        .flow-step.input { border-color: #2196F3; background: #e3f2fd; }
        .flow-step.decision { border-color: #FF9800; background: #fff3e0; }
        .flow-step.calculation { border-color: #9C27B0; background: #f3e5f5; }
        .flow-step.result { border-color: #009688; background: #e0f2f1; }

        .step-title {
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .arrow {
            text-align: center;
            font-size: 1.5rem;
            color: #666;
            margin: 5px 0;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group h3 {
            color: #26d0ce;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
        }

        .input-row label {
            flex: 1;
            font-weight: 600;
            color: #444;
            font-size: 0.95rem;
        }

        .input-row input, .input-row select {
            flex: 1.5;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .input-row input:focus, .input-row select:focus {
            border-color: #26d0ce;
            outline: none;
            box-shadow: 0 0 0 3px rgba(38, 208, 206, 0.2);
        }

        .input-row input.error {
            border-color: #dc3545;
            background-color: #fff5f5;
        }

        .unit {
            flex: 0.5;
            color: #666;
            font-size: 0.9rem;
        }

        .error-text {
            color: #dc3545;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
            font-weight: 500;
        }

        .geometry-selection {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .geometry-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
        }

        .geometry-btn.active {
            border-color: #1a2980;
            background: #1a2980;
            color: white;
        }

        .calculate-btn {
            display: block;
            width: 100%;
            padding: 16px;
            background: linear-gradient(to right, #1a2980, #26d0ce);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 25px 0;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(0, 0, 0, 0.1);
        }

        .calculate-btn:disabled {
            background: linear-gradient(to right, #cccccc, #999999);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-section {
            background: #f8fdff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #26d0ce;
            display: none;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .result-label {
            font-weight: 600;
            color: #444;
        }

        .result-value {
            font-weight: 700;
            color: #1a2980;
            font-size: 1.1rem;
        }

        .flow-regime {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .laminar { background-color: #d4edda; color: #155724; }
        .transition { background-color: #fff3cd; color: #856404; }
        .turbulent { background-color: #f8d7da; color: #721c24; }

        .chart-container {
            height: 300px;
            margin-top: 20px;
            display: none;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            border-left: 4px solid #dc3545;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            border-left: 4px solid #28a745;
        }

        .warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 0.9rem;
            border-left: 4px solid #ffc107;
        }

        .fluid-properties {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.9rem;
            border-left: 4px solid #2196F3;
        }

        .validation-pass {
            color: #155724;
            background-color: #d4edda;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .validation-fail {
            color: #721c24;
            background-color: #f8d7da;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .equation-box {
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
            font-family: 'Courier New', monospace;
        }

        .iteration-info {
            background: #e8f4f8;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 0.85rem;
            border-left: 4px solid #5bc0de;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Forced Convection Heat Transfer Calculator</h1>
            <p>Internal Forced Convection Analysis Following Table 4.3 Correlations</p>
        </header>

        <section class="flowchart-section">
            <h2>Methodology Flowchart</h2>
            <div class="flowchart-container">
                <div class="flow-step start">
                    <span class="step-title">START</span>
                    <span class="step-content">Internal Forced Convection Analysis</span>
                </div>
                <div class="arrow">‚Üì</div>
                <div class="flow-step input" id="flow-input">
                    <span class="step-title">INPUT</span>
                    <div class="step-content"></div>
                </div>
                <div class="arrow">‚Üì</div>
                <div class="flow-step decision">
                    <span class="step-title">VALIDATION</span>
                    <div class="step-content">
                        Check all inputs > 0<br>
                        <span id="flow-validation" class="validation-pass">‚úì All inputs valid</span>
                    </div>
                </div>
                <div class="arrow">‚Üì</div>
                <div class="flow-step calculation" id="flow-properties">
                    <span class="step-title">COMPUTE PROPERTIES</span>
                    <div class="step-content"></div>
                </div>
                <div class="arrow">‚Üì</div>
                <div class="flow-step calculation" id="flow-reynolds">
                    <span class="step-title">REYNOLDS & PRANDTL</span>
                    <div class="step-content"></div>
                </div>
                <div class="arrow">‚Üì</div>
                <div class="flow-step decision" id="flow-regime-check">
                    <span class="step-title">FLOW REGIME CHECK</span>
                    <div class="step-content"></div>
                </div>
                <div class="arrow">‚Üì</div>
                <div class="flow-step calculation" id="flow-entry-lengths">
                    <span class="step-title">ENTRY LENGTHS</span>
                    <div class="step-content"></div>
                </div>
                <div class="arrow">‚Üì</div>
                <div class="flow-step calculation" id="flow-nusselt">
                    <span class="step-title">NUSSELT NUMBER (Table 4.3)</span>
                    <div class="step-content"></div>
                </div>
                <div class="arrow">‚Üì</div>
                <div class="flow-step result" id="flow-results">
                    <span class="step-title">RESULTS</span>
                    <div class="step-content"></div>
                </div>
                <div class="arrow">‚Üì</div>
                <div class="flow-step result">
                    <span class="step-title">END</span>
                    <span class="step-content">Analysis Complete</span>
                </div>
            </div>
        </section>

        <section class="calculator-section">
            <h2>Input Parameters</h2>
            
            <div class="input-group">
                <h3>üìê Geometry Selection</h3>
                <div class="geometry-selection">
                    <div class="geometry-btn active" data-geometry="circular">Circular Pipe</div>
                    <div class="geometry-btn" data-geometry="square">Square Duct</div>
                    <div class="geometry-btn" data-geometry="rectangular">Rectangular Duct</div>
                </div>
                
                <div id="circular-inputs">
                    <div class="input-row">
                        <label for="diameter">Pipe Diameter (D):</label>
                        <input type="number" id="diameter" value="0.05" step="0.001">
                        <span class="unit">m</span>
                    </div>
                    <div class="error-text" id="diameter-error"></div>
                </div>
                
                <div id="square-inputs" style="display: none;">
                    <div class="input-row">
                        <label for="side">Side Length (a):</label>
                        <input type="number" id="side" value="0.05" step="0.001">
                        <span class="unit">m</span>
                    </div>
                    <div class="error-text" id="side-error"></div>
                </div>
                
                <div id="rectangular-inputs" style="display: none;">
                    <div class="input-row">
                        <label for="width">Width (w):</label>
                        <input type="number" id="width" value="0.05" step="0.001">
                        <span class="unit">m</span>
                    </div>
                    <div class="error-text" id="width-error"></div>
                    <div class="input-row">
                        <label for="height">Height (h):</label>
                        <input type="number" id="height" value="0.025" step="0.001">
                        <span class="unit">m</span>
                    </div>
                    <div class="error-text" id="height-error"></div>
                </div>
                
                <div class="input-row">
                    <label for="length">Length (L):</label>
                    <input type="number" id="length" value="1.0" step="0.1">
                    <span class="unit">m</span>
                </div>
                <div class="error-text" id="length-error"></div>
            </div>
            
            <div class="input-group">
                <h3>üíß Fluid Properties</h3>
                <div class="input-row">
                    <label for="fluid">Fluid Type:</label>
                    <select id="fluid">
                        <option value="air">Air</option>
                        <option value="water">Water</option>
                        <option value="engine-oil">Engine Oil</option>
                    </select>
                </div>
                
                <div class="fluid-properties" id="fluid-props-display">
                    Select fluid to see properties
                </div>
                
                <div class="input-row">
                    <label for="velocity">Velocity (V):</label>
                    <input type="number" id="velocity" value="2.0" step="0.1">
                    <span class="unit">m/s</span>
                </div>
                <div class="error-text" id="velocity-error"></div>
            </div>
            
            <div class="input-group">
                <h3>üå°Ô∏è Temperature Conditions</h3>
                <div class="input-row">
                    <label for="inlet-temp">Inlet Temperature (Ti):</label>
                    <input type="number" id="inlet-temp" value="300" step="1">
                    <span class="unit">K</span>
                </div>
                <div class="error-text" id="inlet-temp-error"></div>
                <div class="input-row">
                    <label for="wall-temp">Wall Temperature (Tw):</label>
                    <input type="number" id="wall-temp" value="350" step="1">
                    <span class="unit">K</span>
                </div>
                <div class="error-text" id="wall-temp-error"></div>
                <div class="warning">
                    Note: All temperatures in Kelvin (K). 0¬∞C = 273.15K, 20¬∞C = 293.15K
                </div>
            </div>
            
            <div class="equation-box">
                <strong>Table 4.3 Nusselt Number Correlations:</strong><br>
                ‚Ä¢ Laminar (Re ‚â§ 2300), Fully Developed: Nu = 3.66<br>
                ‚Ä¢ Laminar (Re ‚â§ 2300), Developing: Special correlation<br>
                ‚Ä¢ Turbulent (Re > 4000): Nu = 0.023 Re<sup>0.8</sup> Pr<sup>n</sup><br>
                ‚Ä¢ Transition (2300 < Re < 4000): Linear interpolation<br>
                n = 0.4 for heating (Tw > Tb), 0.3 for cooling
            </div>
            
            <div class="iteration-info" id="iteration-info" style="display: none;">
                <strong>Property Iteration:</strong>
                <div id="iteration-details"></div>
            </div>
            
            <div class="error-message" id="error-message">
                <strong>Invalid Inputs Detected:</strong>
                <ul id="error-list"></ul>
            </div>
            
            <div class="success-message" id="success-message">
                <strong>‚úì All inputs are valid!</strong> Click calculate to proceed.
            </div>
            
            <button class="calculate-btn" id="calculate-btn" disabled>CALCULATE HEAT TRANSFER</button>
            
            <div class="result-section" id="result-section">
                <h3>üìä Calculation Results</h3>
                <div id="results-container"></div>
            </div>
            
            <div class="chart-container" id="chart-container">
                <canvas id="temperature-chart"></canvas>
            </div>
        </section>
    </div>

    <script>
        class ConvectionCalculator {
            constructor() {
                this.initializeElements();
                this.setupEventListeners();
                this.initializeChart();
                this.updateFlowchartInputs();
                this.updateFluidPropertiesDisplay();
            }
            
            initializeElements() {
                // DOM elements
                this.elements = {
                    geometryBtns: document.querySelectorAll('.geometry-btn'),
                    calculateBtn: document.getElementById('calculate-btn'),
                    errorMessage: document.getElementById('error-message'),
                    successMessage: document.getElementById('success-message'),
                    resultSection: document.getElementById('result-section'),
                    chartContainer: document.getElementById('chart-container'),
                    errorList: document.getElementById('error-list'),
                    resultsContainer: document.getElementById('results-container'),
                    iterationInfo: document.getElementById('iteration-info'),
                    iterationDetails: document.getElementById('iteration-details'),
                    
                    // Geometry inputs
                    circularInputs: document.getElementById('circular-inputs'),
                    squareInputs: document.getElementById('square-inputs'),
                    rectangularInputs: document.getElementById('rectangular-inputs'),
                    
                    // Input fields
                    diameterInput: document.getElementById('diameter'),
                    sideInput: document.getElementById('side'),
                    widthInput: document.getElementById('width'),
                    heightInput: document.getElementById('height'),
                    lengthInput: document.getElementById('length'),
                    fluidSelect: document.getElementById('fluid'),
                    velocityInput: document.getElementById('velocity'),
                    inletTempInput: document.getElementById('inlet-temp'),
                    wallTempInput: document.getElementById('wall-temp'),
                    fluidPropsDisplay: document.getElementById('fluid-props-display'),
                    
                    // Flowchart elements
                    flowInput: document.getElementById('flow-input').querySelector('.step-content'),
                    flowProperties: document.getElementById('flow-properties').querySelector('.step-content'),
                    flowReynolds: document.getElementById('flow-reynolds').querySelector('.step-content'),
                    flowRegimeCheck: document.getElementById('flow-regime-check').querySelector('.step-content'),
                    flowEntryLengths: document.getElementById('flow-entry-lengths').querySelector('.step-content'),
                    flowNusselt: document.getElementById('flow-nusselt').querySelector('.step-content'),
                    flowResults: document.getElementById('flow-results').querySelector('.step-content'),
                    flowValidation: document.getElementById('flow-validation')
                };
            }
            
            setupEventListeners() {
                // Geometry selection
                this.elements.geometryBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => this.selectGeometry(e.target));
                });
                
                // Fluid selection
                this.elements.fluidSelect.addEventListener('change', () => this.updateFluidPropertiesDisplay());
                
                // Real-time input validation
                const inputs = [
                    this.elements.diameterInput, this.elements.sideInput,
                    this.elements.widthInput, this.elements.heightInput,
                    this.elements.lengthInput, this.elements.velocityInput,
                    this.elements.inletTempInput, this.elements.wallTempInput
                ];
                
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        this.validateInput(input);
                        this.validateAllInputs();
                        this.updateFlowchartInputs();
                    });
                });
                
                // Calculate button
                this.elements.calculateBtn.addEventListener('click', () => this.calculate());
            }
            
            selectGeometry(button) {
                this.elements.geometryBtns.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                const geometry = button.dataset.geometry;
                this.updateGeometryInputs(geometry);
                this.validateAllInputs();
            }
            
            updateGeometryInputs(geometry) {
                this.elements.circularInputs.style.display = 'none';
                this.elements.squareInputs.style.display = 'none';
                this.elements.rectangularInputs.style.display = 'none';
                
                if (geometry === 'circular') {
                    this.elements.circularInputs.style.display = 'block';
                } else if (geometry === 'square') {
                    this.elements.squareInputs.style.display = 'block';
                } else if (geometry === 'rectangular') {
                    this.elements.rectangularInputs.style.display = 'block';
                }
            }
            
            getActiveGeometry() {
                const activeBtn = document.querySelector('.geometry-btn.active');
                return activeBtn ? activeBtn.dataset.geometry : 'circular';
            }
            
            validateInput(input) {
                const value = parseFloat(input.value);
                const errorElement = document.getElementById(`${input.id}-error`);
                
                // Clear previous error
                input.classList.remove('error');
                if (errorElement) {
                    errorElement.style.display = 'none';
                    errorElement.textContent = '';
                }
                
                // Check for empty or invalid
                if (isNaN(value)) {
                    input.classList.add('error');
                    if (errorElement) {
                        errorElement.textContent = "Invalid input: Please enter a valid number.";
                        errorElement.style.display = 'block';
                    }
                    return false;
                }
                
                // Check for zero or negative
                if (value <= 0) {
                    input.classList.add('error');
                    if (errorElement) {
                        errorElement.textContent = "Invalid input: Please enter a value larger than 0.";
                        errorElement.style.display = 'block';
                    }
                    return false;
                }
                
                // Temperature range check
                if (input.id.includes('temp')) {
                    if (value < 200 || value > 1000) {
                        input.classList.add('error');
                        if (errorElement) {
                            errorElement.textContent = "Temperature must be between 200K and 1000K.";
                            errorElement.style.display = 'block';
                        }
                        return false;
                    }
                }
                
                return true;
            }
            
            validateAllInputs() {
                const geometry = this.getActiveGeometry();
                const errors = [];
                let allValid = true;
                
                // Validate geometry-specific inputs
                if (geometry === 'circular') {
                    if (!this.validateInput(this.elements.diameterInput)) {
                        errors.push("Pipe Diameter must be > 0");
                        allValid = false;
                    }
                } else if (geometry === 'square') {
                    if (!this.validateInput(this.elements.sideInput)) {
                        errors.push("Side Length must be > 0");
                        allValid = false;
                    }
                } else if (geometry === 'rectangular') {
                    if (!this.validateInput(this.elements.widthInput)) {
                        errors.push("Width must be > 0");
                        allValid = false;
                    }
                    if (!this.validateInput(this.elements.heightInput)) {
                        errors.push("Height must be > 0");
                        allValid = false;
                    }
                }
                
                // Validate common inputs
                const requiredInputs = [
                    { input: this.elements.lengthInput, name: "Length" },
                    { input: this.elements.velocityInput, name: "Velocity" },
                    { input: this.elements.inletTempInput, name: "Inlet Temperature" },
                    { input: this.elements.wallTempInput, name: "Wall Temperature" }
                ];
                
                requiredInputs.forEach(item => {
                    if (!this.validateInput(item.input)) {
                        errors.push(`${item.name} must be > 0`);
                        allValid = false;
                    }
                });
                
                // Update UI
                if (allValid) {
                    this.elements.errorMessage.style.display = 'none';
                    this.elements.successMessage.style.display = 'block';
                    this.elements.calculateBtn.disabled = false;
                    this.elements.flowValidation.textContent = "‚úì All inputs valid";
                    this.elements.flowValidation.className = "validation-pass";
                } else {
                    this.elements.errorMessage.style.display = 'block';
                    this.elements.successMessage.style.display = 'none';
                    this.elements.calculateBtn.disabled = true;
                    this.elements.flowValidation.textContent = "‚úó Invalid inputs";
                    this.elements.flowValidation.className = "validation-fail";
                    
                    // Update error list
                    this.elements.errorList.innerHTML = '';
                    errors.forEach(error => {
                        const li = document.createElement('li');
                        li.textContent = error;
                        this.elements.errorList.appendChild(li);
                    });
                }
                
                return allValid;
            }
            
            updateFlowchartInputs() {
                const geometry = this.getActiveGeometry();
                let dims = '';
                
                if (geometry === 'circular') {
                    dims = `D=${this.elements.diameterInput.value || 0}m`;
                } else if (geometry === 'square') {
                    dims = `a=${this.elements.sideInput.value || 0}m`;
                } else if (geometry === 'rectangular') {
                    dims = `w=${this.elements.widthInput.value || 0}m, h=${this.elements.heightInput.value || 0}m`;
                }
                
                this.elements.flowInput.innerHTML = `
                    ‚Ä¢ Geometry: ${geometry.charAt(0).toUpperCase() + geometry.slice(1)}<br>
                    ‚Ä¢ Fluid: ${this.elements.fluidSelect.options[this.elements.fluidSelect.selectedIndex].text}<br>
                    ‚Ä¢ V = ${this.elements.velocityInput.value || 0} m/s<br>
                    ‚Ä¢ Ti = ${this.elements.inletTempInput.value || 0} K<br>
                    ‚Ä¢ Tw = ${this.elements.wallTempInput.value || 0} K<br>
                    ‚Ä¢ L = ${this.elements.lengthInput.value || 0} m<br>
                    ‚Ä¢ Dimensions: ${dims}
                `;
            }
            
            updateFluidPropertiesDisplay() {
                const fluid = this.elements.fluidSelect.value;
                const props = this.getFluidProperties(fluid, 300);
                
                this.elements.fluidPropsDisplay.innerHTML = `
                    <strong>${fluid.charAt(0).toUpperCase() + fluid.slice(1)} properties at 300K:</strong><br>
                    ‚Ä¢ œÅ = ${props.density.toFixed(3)} kg/m¬≥<br>
                    ‚Ä¢ Œº = ${props.viscosity.toExponential(3)} Pa¬∑s<br>
                    ‚Ä¢ k = ${props.conductivity.toFixed(4)} W/m¬∑K<br>
                    ‚Ä¢ Cp = ${props.specificHeat.toFixed(0)} J/kg¬∑K<br>
                    ‚Ä¢ Pr = ${props.prandtl.toFixed(3)}
                `;
            }
            
            // CORRECTED: Accurate fluid property functions
            getFluidProperties(fluid, T) {
                T = Math.max(T, 250); // Ensure reasonable temperature
                
                switch(fluid) {
                    case 'air':
                        // Ideal gas law: œÅ = P/(RT), P=101325 Pa, R=287 J/kg¬∑K
                        const density = 101325 / (287 * T);
                        
                        // Sutherland's law approximation for air viscosity
                        const mu0 = 1.716e-5; // Reference viscosity at 273K
                        const T0 = 273;
                        const S = 110.4; // Sutherland constant for air
                        const viscosity = mu0 * Math.pow(T/T0, 1.5) * (T0 + S) / (T + S);
                        
                        // Conductivity: k = 0.0263 at 300K, linear approximation
                        const conductivity = 0.0241 + 0.00007 * (T - 273);
                        
                        // Prandtl number for air
                        const prandtl = 0.707 - 0.0001 * (T - 300);
                        
                        return {
                            density: density,
                            viscosity: viscosity,
                            conductivity: conductivity,
                            specificHeat: 1007,
                            prandtl: Math.max(0.65, Math.min(0.75, prandtl))
                        };
                        
                    case 'water':
                        // Water properties at ~300K
                        return {
                            density: 997,
                            viscosity: 8.9e-4,
                            conductivity: 0.607,
                            specificHeat: 4182,
                            prandtl: 6.14
                        };
                        
                    case 'engine-oil':
                        // Engine oil at ~300K
                        return {
                            density: 888,
                            viscosity: 0.8,
                            conductivity: 0.145,
                            specificHeat: 1880,
                            prandtl: 10500
                        };
                        
                    default:
                        return this.getFluidProperties('air', T);
                }
            }
            
            initializeChart() {
                const ctx = document.getElementById('temperature-chart').getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Fluid Temperature',
                            data: [],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Temperature Distribution Along Duct Length'
                            }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Length (m)' } },
                            y: { title: { display: true, text: 'Temperature (K)' } }
                        }
                    }
                });
            }
            
            // CORRECTED Nusselt number calculation based on Table 4.3
            calculateNusseltNumber(Re, Pr, L, Dh, Tw, Tb, regime) {
                let Nu, equation, condition;
                
                // Determine if flow is heating or cooling
                const isHeating = Tw > Tb;
                const n = isHeating ? 0.4 : 0.3;
                
                // Calculate entry lengths
                const L_hyd = 0.05 * Re * Dh; // Hydrodynamic entry length
                const L_th = L_hyd * Pr;      // Thermal entry length
                const isFullyDeveloped = L >= L_hyd && L >= L_th;
                
                if (regime === "Laminar") {
                    if (isFullyDeveloped) {
                        condition = "Fully Developed";
                        Nu = 3.66; // Constant wall temperature
                        equation = "Nu = 3.66 (Table 4.3)";
                    } else {
                        condition = "Developing";
                        // Graetz number approach
                        const Gz = (Dh / L) * Re * Pr;
                        if (Gz > 100) {
                            Nu = 1.86 * Math.pow(Gz, 1/3);
                            equation = "Nu = 1.86 (Re Pr Dh/L)^{1/3}";
                        } else {
                            Nu = 3.66 + (0.0668 * Gz) / (1 + 0.04 * Math.pow(Gz, 2/3));
                            equation = "Nu = 3.66 + 0.0668Gz/(1+0.04Gz^{2/3})";
                        }
                    }
                } 
                else if (regime === "Turbulent") {
                    condition = "Fully Turbulent";
                    // Dittus-Boelter correlation
                    Nu = 0.023 * Math.pow(Re, 0.8) * Math.pow(Pr, n);
                    equation = `Nu = 0.023 Re^0.8 Pr^${n} (Table 4.3)`;
                }
                else if (regime === "Transitional") {
                    condition = "Interpolated";
                    // Interpolate between laminar (Re=2300) and turbulent (Re=4000)
                    const laminarNu = 3.66; // Fully developed laminar
                    const turbulentNu = 0.023 * Math.pow(Re, 0.8) * Math.pow(Pr, n);
                    const fraction = (Re - 2300) / (4000 - 2300);
                    Nu = laminarNu + (turbulentNu - laminarNu) * fraction;
                    equation = "Linear interpolation between laminar and turbulent";
                }
                
                return { Nu, regime, condition, equation, L_hyd, L_th, isFullyDeveloped };
            }
            
            // ITERATIVE SOLUTION FOR ACCURATE RESULTS
            calculate() {
                if (!this.validateAllInputs()) return;
                
                // Get inputs
                const geometry = this.getActiveGeometry();
                const L = parseFloat(this.elements.lengthInput.value);
                const V = parseFloat(this.elements.velocityInput.value);
                const Ti = parseFloat(this.elements.inletTempInput.value);
                const Tw = parseFloat(this.elements.wallTempInput.value);
                const fluid = this.elements.fluidSelect.value;
                
                // Calculate geometry properties
                let Dh, Ac, As;
                switch(geometry) {
                    case 'circular':
                        const D = parseFloat(this.elements.diameterInput.value);
                        Dh = D;
                        Ac = Math.PI * D * D / 4;
                        As = Math.PI * D * L;
                        break;
                    case 'square':
                        const a = parseFloat(this.elements.sideInput.value);
                        Dh = a;
                        Ac = a * a;
                        As = 4 * a * L;
                        break;
                    case 'rectangular':
                        const w = parseFloat(this.elements.widthInput.value);
                        const h = parseFloat(this.elements.heightInput.value);
                        Dh = 2 * w * h / (w + h);
                        Ac = w * h;
                        As = 2 * (w + h) * L;
                        break;
                }
                
                // ITERATIVE SOLUTION STARTS HERE
                this.elements.iterationInfo.style.display = 'block';
                let iterationDetails = [];
                
                // Initial guess: use film temperature for properties
                let Tb_guess = (Ti + Tw) / 2;
                let To_guess = Ti + 10; // Initial outlet temperature guess
                let props, Re, Pr, regime, nusseltResult, h, mdot, Cp, To, Q;
                
                const maxIterations = 50;
                const tolerance = 0.01;
                
                for (let iter = 0; iter < maxIterations; iter++) {
                    // Calculate properties at current bulk mean temperature
                    const Tb_current = (Ti + To_guess) / 2;
                    props = this.getFluidProperties(fluid, Tb_current);
                    
                    // Calculate Re and Pr
                    Re = (props.density * V * Dh) / props.viscosity;
                    Pr = props.prandtl;
                    
                    // Determine flow regime
                    if (Re <= 2300) {
                        regime = "Laminar";
                    } else if (Re > 4000) {
                        regime = "Turbulent";
                    } else {
                        regime = "Transitional";
                    }
                    
                    // Calculate Nusselt number
                    nusseltResult = this.calculateNusseltNumber(Re, Pr, L, Dh, Tw, Tb_current, regime);
                    
                    // Heat transfer coefficient
                    h = (nusseltResult.Nu * props.conductivity) / Dh;
                    
                    // Mass flow rate
                    mdot = props.density * V * Ac;
                    Cp = props.specificHeat;
                    
                    // Calculate new outlet temperature
                    const exponent = -h * As / (mdot * Cp);
                    To = Tw - (Tw - Ti) * Math.exp(exponent);
                    
                    // Check convergence
                    const deltaT = Math.abs(To - To_guess);
                    To_guess = To;
                    
                    iterationDetails.push(`Iter ${iter+1}: Tb=${Tb_current.toFixed(1)}K, Re=${Re.toFixed(0)}, Nu=${nusseltResult.Nu.toFixed(2)}, To=${To.toFixed(1)}K`);
                    
                    if (deltaT < tolerance) {
                        iterationDetails.push(`‚úì Converged after ${iter+1} iterations`);
                        break;
                    }
                    
                    if (iter === maxIterations - 1) {
                        iterationDetails.push(`‚ö† Maximum iterations reached (${maxIterations})`);
                    }
                }
                
                // Final heat transfer rate
                Q = mdot * Cp * (To - Ti);
                
                // Update iteration info
                this.elements.iterationDetails.innerHTML = iterationDetails.join('<br>');
                
                // Update flowchart
                this.elements.flowProperties.innerHTML = `
                    ‚Ä¢ Ac = ${Ac.toExponential(4)} m¬≤<br>
                    ‚Ä¢ As = ${As.toFixed(3)} m¬≤<br>
                    ‚Ä¢ Dh = ${Dh.toFixed(3)} m<br>
                    ‚Ä¢ Fluid properties at Tb = ${((Ti + To)/2).toFixed(1)} K
                `;
                
                this.elements.flowReynolds.innerHTML = `
                    ‚Ä¢ Re = ${Re.toFixed(0)}<br>
                    ‚Ä¢ Pr = ${Pr.toFixed(3)}<br>
                    <span class="flow-regime ${regime.toLowerCase()}">${regime} Flow</span>
                `;
                
                this.elements.flowEntryLengths.innerHTML = `
                    ‚Ä¢ Lh = ${nusseltResult.L_hyd.toFixed(2)} m (Hydrodynamic)<br>
                    ‚Ä¢ Lt = ${nusseltResult.L_th.toFixed(2)} m (Thermal)<br>
                    ‚Ä¢ L ‚â• Lh? ${L >= nusseltResult.L_hyd ? 'Yes' : 'No'}<br>
                    ‚Ä¢ L ‚â• Lt? ${L >= nusseltResult.L_th ? 'Yes' : 'No'}<br>
                    ‚Ä¢ Condition: ${nusseltResult.isFullyDeveloped ? 'Fully Developed' : 'Developing'}
                `;
                
                this.elements.flowNusselt.innerHTML = `
                    ‚Ä¢ Flow Regime: ${regime}<br>
                    ‚Ä¢ Condition: ${nusseltResult.condition}<br>
                    ‚Ä¢ ${nusseltResult.equation}<br>
                    ‚Ä¢ Calculated: Nu = ${nusseltResult.Nu.toFixed(2)}
                `;
                
                this.elements.flowResults.innerHTML = `
                    ‚Ä¢ h = ${h.toFixed(1)} W/m¬≤¬∑K<br>
                    ‚Ä¢ ·πÅ = ${mdot.toExponential(3)} kg/s<br>
                    ‚Ä¢ To = ${To.toFixed(1)} K<br>
                    ‚Ä¢ Q = ${Q.toFixed(1)} W
                `;
                
                // Display results
                this.displayResults(Re, Pr, regime, nusseltResult.condition, 
                                  nusseltResult.equation, nusseltResult.L_hyd, 
                                  nusseltResult.L_th, L, nusseltResult.Nu, 
                                  h, mdot, To, Q);
                
                // Update chart
                this.updateTemperatureChart(L, Ti, To);
                
                // Show results
                this.elements.resultSection.style.display = 'block';
                this.elements.chartContainer.style.display = 'block';
            }
            
            displayResults(Re, Pr, regime, condition, equation, Lh, Lt, L, Nu, h, mdot, To, Q) {
                const regimeClass = regime.toLowerCase();
                const development = L >= Lh && L >= Lt ? 'Fully Developed' : 
                                  L >= Lh ? 'Thermally Developing' : 'Hydrodynamically Developing';
                
                this.elements.resultsContainer.innerHTML = `
                    <div class="result-item">
                        <span class="result-label">Reynolds Number (Re):</span>
                        <span class="result-value">${Re.toFixed(0)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Prandtl Number (Pr):</span>
                        <span class="result-value">${Pr.toFixed(3)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Flow Regime:</span>
                        <span class="result-value">
                            <span class="flow-regime ${regimeClass}">${regime}</span>
                        </span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Flow Condition:</span>
                        <span class="result-value">${condition}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Nusselt Correlation:</span>
                        <span class="result-value">${equation}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Nusselt Number (Nu):</span>
                        <span class="result-value">${Nu.toFixed(2)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Heat Transfer Coefficient (h):</span>
                        <span class="result-value">${h.toFixed(1)} W/m¬≤¬∑K</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Mass Flow Rate (·πÅ):</span>
                        <span class="result-value">${mdot.toExponential(3)} kg/s</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Outlet Temperature (To):</span>
                        <span class="result-value">${To.toFixed(1)} K</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Heat Transfer Rate (Q):</span>
                        <span class="result-value">${Q.toFixed(1)} W</span>
                    </div>
                `;
            }
            
            updateTemperatureChart(L, Ti, To) {
                const numPoints = 20;
                const positions = [];
                const temperatures = [];
                
                for (let i = 0; i <= numPoints; i++) {
                    const x = (i / numPoints) * L;
                    positions.push(x.toFixed(2));
                    const progress = x / L;
                    // Exponential temperature distribution for constant wall temp
                    const temp = Ti + (To - Ti) * (1 - Math.exp(-progress * 3));
                    temperatures.push(temp);
                }
                
                this.chart.data.labels = positions;
                this.chart.data.datasets[0].data = temperatures;
                this.chart.update();
            }
        }
        
        // Initialize calculator when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.calculator = new ConvectionCalculator();
        });
    </script>
</body>
</html>
